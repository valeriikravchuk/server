# Testing of logging of ddl's under backup stages

--source include/have_innodb.inc
--source include/not_embedded.inc

connect (con1,localhost,root,,);
BACKUP STAGE START;
connection default;

--echo #
--echo # Testing with normal tables
--echo #

create table t1 (a int) engine=myisam;
insert into t1 values (1),(2);
alter table t1 add column b int;
alter table t1 rename as t2;
rename table t2 to t1;
truncate table t1;
repair table t1;
optimize table t1;
drop table t1;

create table t1_innodb (a int) engine=innodb;
insert into t1_innodb values (1),(2);
alter table t1_innodb add column b int;
alter table t1_innodb rename as t2_innodb;
rename table t2_innodb to t1_innodb;
truncate table t1_innodb;
repair table t1_innodb;
optimize table t1_innodb;
drop table t1_innodb;

--echo #
--echo # Testing with temporary tables (should not be logged)
--echo #

create temporary table tmp_t10 (a int) engine=myisam;
alter table tmp_t10 add column b int;
alter table tmp_t10 rename as tmp_t11;
rename table tmp_t11 to tmp_t10;
truncate table tmp_t10;
drop table tmp_t10;

--echo #
--echo # Testing with mix of normal and temporary tables
--echo #

create temporary table tmp_t20 (a int);
create table t20 (a int);
drop table tmp_t20,t20;

create temporary table tmp_t21 (a int);
create table t21 (a int);
drop temporary table if exists tmp_t21,t21;
drop table if exists tmp_t21,t21;

--echo #
--echo # Testing create select
--echo #

create table t30 (a int);
insert into t30 values (1),(1);
create table t31 (a int primary key) select * from t30 limit 1;
create or replace table t31 select * from t30 limit 1;
create or replace temporary table t30_dup select * from t30 limit 1;
--error ER_DUP_ENTRY
create or replace table t31 (a int primary key) select * from t30;
create table t32 (b int);
drop table if exists t30,t31,t32,tmp_t30;

--echo #
--echo # Testing create LIKE
--echo #

create table t40 (a int) engine=myisam;
create table t41 (a int, b int) engine=innodb;
create table t42 like t40;
create temporary table t43_tmp like t40;
create or replace table t42 like t41;
show create table t42;
drop table t40, t41, t42;

--echo #
--echo # Testing rename
--echo #

create table t50 (a int);
create table t51 (a int, b int);
rename table t50 to t52, t51 to t53;
rename table t52 to tmp, t53 to t52, tmp to t53;
drop table t52,t53;

--echo #
--echo # Testing enable/disable keys
--echo #

CREATE TABLE t60 (i int(10), index(i) ) ENGINE=Aria;
INSERT INTO t60 VALUES(1),(2),(3);
ALTER TABLE t60 DISABLE KEYS;
INSERT INTO t60 VALUES(4),(5),(6);
ALTER TABLE t60 ENABLE KEYS;
DROP TABLE t60;

CREATE TEMPORARY TABLE t61 (i int(10), index(i) ) ENGINE=Aria;
INSERT INTO t61 VALUES(1),(2),(3);
ALTER TABLE t61 DISABLE KEYS;
DROP TABLE t61;

--echo #
--echo # Testing load data
--echo #

create table t70 (a date, b date, c date not null, d date) engine=aria;
--disable_warnings
load data infile '../../std_data/loaddata1.dat' ignore into table t70 fields terminated by ',';
load data infile '../../std_data/loaddata1.dat' ignore into table t70 fields terminated by ',';
truncate table t70;
lock table t70 write;
load data infile '../../std_data/loaddata1.dat' ignore into table t70 fields terminated by ',';
load data infile '../../std_data/loaddata1.dat' ignore into table t70 fields terminated by ',';
unlock tables;
--enable_warnings

create table t71 (a date, b date, c date not null, d date) engine=aria;
lock tables t71 write, t70 read;
insert into t71 select * from t70;
unlock tables;
drop table t70,t71;

--echo #
--echo # Testing strange table names
--echo #

create table `t 1` (a int);
drop table `t 1`;

--echo #
--echo # Testing views and triggers
--echo #

create table t80 (a int, b int) engine=myisam;
create view v1 as select * from t80;
create trigger trg before insert on t80 for each row set @b:=1;
drop trigger trg;
drop view v1;
drop table t80;

--echo #
--echo # Testing alter to a new storage engine
--echo #

create table t85 (a int primary key, b int) engine=myisam;
alter table t85 engine=innodb;
drop table t85;

--echo #
--echo # Testing create/drop/alter database
--echo #

create database mysqltest;
create table mysqltest.t90 (a int primary key, b int) engine=myisam;
create table mysqltest.t91 (a int primary key, b int) engine=innodb;
alter database mysqltest character set utf8;
drop database mysqltest;

--source include/print_ddl_log.inc

--echo #
--echo # Cleanup
--echo #

disconnect con1;
